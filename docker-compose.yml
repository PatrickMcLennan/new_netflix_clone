version: '3'
services:

  mysql:
    image: mysql/mysql-server
    restart: always
    environment: 
      ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
    ports: 
      - ${MYSQL_PORT}:${MYSQL_PORT}
    expose:
      - ${MYSQL_PORT}

  redis:
    image: redis:latest
    ports:
      - ${REDIS_PORT}:${REDIS_PORT}
    command: [ "redis-server" ]
    expose:
      - ${REDIS_PORT}

  nodejs:
    build: ./
    restart: on-failure
    depends_on: 
      - mysql
      - redis
    healthcheck: 
      # Is this working?  Don't think so, because thid build passed and the below is not real..
      test: ["CMD", "curl", "-f", "http://localhost:15672"]
      interval: 5s
      timeout: 10s
      retries: 10

  nginx:
    build: ./nginx
    restart: on-failure
    ports:
      - ${NGINX_PORT}:${NGINX_PORT}
    depends_on:
      - nodejs
      